ğŸ”— è·¯ç½‘ç”Ÿäº§ä¸ä¼˜åŒ–
===================================

è¯¥æ¨¡å—æä¾›äº†ä¸€ç³»åˆ—çš„æ–¹æ³•å¸®åŠ©æ‚¨ç”Ÿäº§gotrackitæ ‡å‡†è·¯ç½‘ï¼Œäº¦æˆ–æ˜¯ å¸®åŠ©æ‚¨ å°† å…¶ä»–æ•°æ®æ¥æºçš„è·¯ç½‘ è½¬åŒ–ä¸ºgotrackitæ ‡å‡†è·¯ç½‘ã€‚gotrackitçš„æ ‡å‡†è·¯ç½‘æ•°æ®ç»“æ„è§ï¼š :doc:`æ•°æ®è¦æ±‚`

.. _è·¯ç½‘ç”Ÿäº§ä»£ç ç¤ºä¾‹:

ä½¿ç”¨è·¯ç½‘ç”Ÿäº§å·¥å…·ï¼Œå…ˆä»gotrackitå¯¼å…¥ç›¸å…³æ¨¡å— ::

    import gotrackit.netreverse.NetGen as ng


è·¯ç½‘ç”Ÿäº§
-------------------------

.. note::

   è¯¥è·¯ç½‘è·å–æ–¹å¼åˆ©ç”¨çš„æ˜¯é«˜å¾·å¼€æ”¾å¹³å°çš„å®˜æ–¹API - è·¯å¾„è§„åˆ’æ¥å£ï¼Œä¸æ¶‰åŠçˆ¬è™«æŠ“åŒ…ï¼


.. note::

   ä»»ä½•éå®˜æ–¹é‡‡è´­å½¢å¼çš„è·¯ç½‘è·å–æ–¹æ³•éƒ½ä¸å¯èƒ½è·å¾—å®Œæ•´çš„è·¯ç½‘æ•°æ®ï¼


.. note::

   ä¾æ®æœ¬å¼€æºåŒ…çš„å¼€æºåè®®ï¼šé€šè¿‡è¯¥æ–¹å¼è·å–çš„è·¯ç½‘æ•°æ®ä¸¥ç¦ç”¨äºå•†ä¸šè¡Œä¸ºï¼Œä»…é™äºæ•™è‚²ä»¥åŠç§‘å­¦ç ”ç©¶è¯¾é¢˜ï¼Œå¦‚æœ‰å•†ç”¨éœ€æ±‚è¯·è”ç³»é«˜å¾·å®¢æœè¿›è¡Œè·¯ç½‘é‡‡è´­ï¼Œæ„Ÿè°¢é«˜å¾·å¼€æ”¾å¹³å°çš„å…è´¹æ¥å£ï¼


.. note::

   è¯·æ³¨æ„ï¼šé€šè¿‡è¯¥æ–¹å¼è·å–çš„è·¯ç½‘çš„åæ ‡ç³»æ˜¯GCJ-02ï¼Œä¸€èˆ¬çš„GPSæ•°æ®åæ ‡ç³»éƒ½æ˜¯WGS-84ã€‚

.. note::

   æœ¬å¼€æºåŒ…è·å–è·¯ç½‘çš„åŸç†ï¼Œå’Œosmä¹‹ç±»çš„å¹³å°è·å–è·¯ç½‘çš„åŸç†ï¼Œæ˜¯ä¸ä¸€æ ·çš„ï¼š

   1.osmæ˜¯åº“é‡Œå·²æœ‰è·¯ç½‘ï¼Œç”¨æˆ·æ¡†é€‰è·å–å±äºæŸ¥è¯¢è·å–ï¼›

   2.gotrackitæ˜¯åŸºäºè·¯å¾„è§„åˆ’APIæ¥å£è¿”å›çš„è·¯å¾„è¿›è¡Œåˆ†æè®¡ç®—ï¼Œä»è€Œè·å–è·¯ç½‘ã€‚æ‰€ä»¥ODæ„é€ çš„ç²¾åº¦å’Œæ•°é‡ç›´æ¥å†³å®šäº†è·¯ç½‘çš„å®Œæ•´åº¦ï¼è¯·ç•™æ„æ„é€ ODçš„æ–¹å¼å’ŒODæ•°é‡ã€‚


è·¯ç½‘ç”Ÿäº§çš„ç›¸å…³å‡½æ•°ä¸éœ€è¦æ‚¨æä¾›ä»»ä½•çš„ç©ºé—´åœ°ç†ä¿¡æ¯æ–‡ä»¶ï¼Œåªéœ€æŒ‡å®šèŒƒå›´ã€å’Œç”³è¯· `å¼€å‘è€…key <https://lbs.amap.com>`_ å³å¯è·å–è·¯ç½‘ã€‚



å‚æ•°è¯¦è§£
``````````````````````````

åˆå§‹åŒ–NetReverseç±»
:::::::::::::::::::

* flag_name
    é¡¹ç›®åç§°ï¼Œå¿…é¡»æŒ‡å®šï¼›

* net_out_fldr
    æœ€ç»ˆè·¯ç½‘çš„å­˜å‚¨ç›®å½•ï¼Œå¿…é¡»æŒ‡å®š

* plain_crs
    ä¾æ®ä½ çš„ç ”ç©¶èŒƒå›´çš„ç»çº¬åº¦(EPSG:4326)é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„å¹³é¢æŠ•å½±åæ ‡ç³»ï¼Œå¿…é¡»æŒ‡å®šï¼Œå‚è§: :doc:`æ•°æ®è¦æ±‚` ä¸­çš„å…­åº¦å¸¦åˆ’åˆ†è§„åˆ™

è¯·æ±‚å‚æ•°
:::::::::::::::::::
* key_list
    å¼€å‘è€…keyå€¼åˆ—è¡¨ï¼Œå¿…é¡»æŒ‡å®š

* binary_path_fldr
    è¯·æ±‚è·¯å¾„æºæ–‡ä»¶çš„å­˜å‚¨ç›®å½•(æœ€å¥½å»ºç«‹ä¸€ä¸ªä¸“é—¨çš„ç›®å½•)ï¼Œå¿…é¡»æŒ‡å®š

* is_rnd_strategy
    æ˜¯å¦å¯ç”¨éšæœºç­–ç•¥è¿›è¡Œè·¯å¾„è¯·æ±‚ï¼Œé»˜è®¤False

* strategy:
    è·¯å¾„è¯·æ±‚ç­–ç•¥ï¼Œå¯é€‰å€¼ä¸ºï¼š

    0ï¼šé€Ÿåº¦ä¼˜å…ˆï¼ˆåªè¿”å›ä¸€æ¡è·¯çº¿ï¼‰ï¼Œæ­¤è·¯çº¿ä¸ä¸€å®šè·ç¦»æœ€çŸ­ï¼›1ï¼šè´¹ç”¨ä¼˜å…ˆï¼ˆåªè¿”å›ä¸€æ¡è·¯çº¿ï¼‰ï¼Œä¸èµ°æ”¶è´¹è·¯æ®µï¼Œä¸”è€—æ—¶æœ€å°‘çš„è·¯çº¿ï¼›2ï¼šè·ç¦»ä¼˜å…ˆï¼ˆåªè¿”å›ä¸€æ¡è·¯çº¿ï¼‰ï¼Œä»…èµ°è·ç¦»æœ€çŸ­çš„è·¯çº¿ï¼Œä½†æ˜¯å¯èƒ½å­˜åœ¨ç©¿è¶Šå°è·¯/å°åŒºçš„æƒ…å†µï¼›32ï¼šé»˜è®¤ï¼Œé«˜å¾·æ¨èï¼ŒåŒé«˜å¾·åœ°å›¾APPé»˜è®¤ï¼›33ï¼šèº²é¿æ‹¥å µï¼›34ï¼šé«˜é€Ÿä¼˜å…ˆï¼›35ï¼šä¸èµ°é«˜é€Ÿï¼›36ï¼šå°‘æ”¶è´¹ï¼›37ï¼šå¤§è·¯ä¼˜å…ˆï¼›38ï¼šé€Ÿåº¦æœ€å¿«ï¼›39ï¼šèº²é¿æ‹¥å µï¼‹é«˜é€Ÿä¼˜å…ˆï¼›40ï¼šèº²é¿æ‹¥å µï¼‹ä¸èµ°é«˜é€Ÿï¼›41ï¼šèº²é¿æ‹¥å µï¼‹å°‘æ”¶è´¹ï¼›42ï¼šå°‘æ”¶è´¹ï¼‹ä¸èµ°é«˜é€Ÿï¼›43ï¼šèº²é¿æ‹¥å µï¼‹å°‘æ”¶è´¹ï¼‹ä¸èµ°é«˜é€Ÿï¼›44ï¼šèº²é¿æ‹¥å µï¼‹å¤§è·¯ä¼˜å…ˆï¼›45ï¼šèº²é¿æ‹¥å µï¼‹é€Ÿåº¦æœ€å¿«


* wait_until_recovery
    å½“keyçš„é…é¢è€—å°½åæ˜¯å¦ç­‰å¾…é…é¢æ¢å¤ï¼Œé»˜è®¤False


* save_log_file
    æ˜¯å¦ä¿å­˜æ—¥å¿—æ–‡ä»¶ï¼Œéå¿…é¡»æŒ‡å®šï¼Œé»˜è®¤False

* log_fldr
    æ—¥å¿—çš„å­˜å‚¨ç›®å½•ï¼Œéå¿…é¡»æŒ‡å®šï¼Œé»˜è®¤None

* min_lngï¼Œmin_lat
    çŸ©å½¢åŒºåŸŸå·¦ä¸‹è§’ç»çº¬åº¦åæ ‡(GCJ-02åæ ‡)ï¼Œå¿…é¡»æŒ‡å®š

* wï¼Œh
    çŸ©å½¢åŒºåŸŸçš„å®½åº¦å’Œé«˜åº¦(ç±³)ï¼Œå¿…é¡»æŒ‡å®šï¼Œé»˜è®¤å€¼2000ï¼Œ2000

* od_type
    ç”ŸæˆODçš„ç±»å‹ï¼Œrand_odã€region_odã€gps_basedï¼Œ

    ä»¥ä¸‹ä¸‰å¼ å›¾åˆ†åˆ«å¯¹åº”od_typeå‚æ•°ä¸ºrand_odã€region_odã€gps_basedï¼š

    .. image:: _static/images/od_gen.png
        :align: center


* od_num
    ç”Ÿæˆçš„odæ•°ï¼Œodæ•°ç›®è¶Šå¤šï¼Œè¯·æ±‚çš„è·¯å¾„å°±è¶Šå¤šï¼Œè·¯ç½‘è¦†ç›–ç‡å°±è¶Šå®Œæ•´ï¼Œé»˜è®¤100ä¸ª

* gap_nï¼Œmin_od_length
    åˆ’åˆ†ç½‘æ ¼æ•°ã€æœ€å°çš„odç›´çº¿è·ç¦»é™åˆ¶ï¼Œéå¿…é¡»æŒ‡å®šï¼Œé»˜è®¤100ï¼Œ1000ï¼Œ1200


æ‰€æœ‰å‚æ•°è§£é‡Šè§ :doc:`ç±»æ–¹æ³•æ±‡æ€»`


åŸºäºçŸ©å½¢åŒºåŸŸéšæœºæ„é€ ODè¯·æ±‚è·¯å¾„, è·å–è·¯ç½‘
``````````````````````````````````````````````````````````````````

ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š


.. code-block:: python
    :linenos:

    if __name__ == '__main__':
        nv = ng.NetReverse(flag_name='test_rectangle', net_out_fldr=r'./data/output/reverse/test_rectangle/',
                       plain_crs='EPSG:32650', save_tpr_link=True, angle_threshold=40)

        # å‚æ•°od_numï¼šä¾æ®è‡ªå·±éœ€æ±‚ç¡®å®šï¼Œod_numè¶Šå¤§ï¼Œè¯·æ±‚çš„è·¯å¾„è¶Šå¤šï¼Œè·¯ç½‘è¦†ç›–ç‡è¶Šé«˜
        nv.generate_net_from_request(key_list=['ä½ çš„Key'],
                                     log_fldr=r'./', save_log_file=True,
                                     binary_path_fldr=r'./data/output/request/test_rectangle/',
                                     w=1500, h=1500, min_lng=126.665019, min_lat=45.747539, od_type='rand_od',
                                     od_num=200, gap_n=1000, min_od_length=800)

è¿è¡Œè¯¥ä»£ç åï¼Œå…ˆåœ¨ç›®å½•./data/output/request/test_rectangle/ä¸‹ç”Ÿæˆè·¯å¾„æºæ–‡ä»¶ï¼Œç„¶ååœ¨ç›®å½•./data/output/reverse/test_rectangle/ä¸‹ç”ŸæˆFinalLink.shpå’ŒFinalNode.shpæ–‡ä»¶


åŸºäºè‡ªå®šä¹‰åŒºåŸŸéšæœºæ„é€ ODè¯·æ±‚è·¯å¾„, è·å–è·¯ç½‘
``````````````````````````````````````````````````````````````

æˆ‘ä»¬é€šè¿‡è¯»å–diy_region.shpæ¥æŒ‡å®šæˆ‘ä»¬æ„é€ éšæœºODçš„åŒºåŸŸèŒƒå›´ï¼š

.. image:: _static/images/diy_region.png
    :align: center

-------------------------------------------------------

ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

.. code-block:: python
    :linenos:

    if __name__ == '__main__':
        nv = ng.NetReverse(flag_name='test_diy_region', net_out_fldr=r'./data/output/reverse/test_diy_region/',
                           plain_crs='EPSG:32650', save_tpr_link=True, angle_threshold=20)
        target_region_gdf = gpd.read_file(r'./data/input/region/diy_region.shp')
        print(target_region_gdf)

        # å‚æ•°od_numï¼šä¾æ®è‡ªå·±éœ€æ±‚ç¡®å®šï¼Œod_numè¶Šå¤§ï¼Œè¯·æ±‚çš„è·¯å¾„è¶Šå¤šï¼Œè·¯ç½‘è¦†ç›–ç‡è¶Šé«˜
        nv.generate_net_from_request(key_list=['ä½ çš„Key'],
                                     log_fldr=r'./', save_log_file=True,
                                     binary_path_fldr=r'./data/output/request/test_diy_region/',
                                     region_gdf=target_region_gdf, od_type='rand_od', gap_n=1000,
                                     min_od_length=1200, od_num=200)


åŸºäºåŒºåŸŸ-åŒºåŸŸODè¯·æ±‚è·¯å¾„, è·å–è·¯ç½‘
````````````````````````````````````````````````

è¯»å–äº¤é€šå°åŒºæ–‡ä»¶ï¼ŒæŒ‡å®šod_typeä¸ºregion_odï¼Œä¼šè‡ªåŠ¨æ„é€ ä¸¤ä¸¤åœ°å—å½¢å¿ƒä¹‹é—´çš„ODã€‚ä½¿ç”¨è¯¥æ–¹æ³•æ„é€ ODï¼Œéœ€è¦ç¡®ä¿é¢åŸŸæ–‡ä»¶ä¸­åŒ…å«region_idå­—æ®µã€‚


.. image:: _static/images/test_taz.png
    :align: center

-------------------------------------------------------


ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

.. code-block:: python
    :linenos:

    if __name__ == '__main__':
        nv = ng.NetReverse(flag_name='test_taz', net_out_fldr=r'./data/output/reverse/test_taz/',
                           plain_crs='EPSG:32650', save_tpr_link=True, angle_threshold=20)
        target_region_gdf = gpd.read_file(r'./data/input/region/simple_taz.shp')
        print(target_region_gdf)

        # å‚æ•°od_numåœ¨åŒºåŸŸ-åŒºåŸŸODä¸‹ä¸ç”Ÿæ•ˆï¼ŒODæ•° = N * N - N, Nä¸ºåŒºåŸŸæ•°é‡
        nv.generate_net_from_request(key_list=['ä½ çš„Key'],
                                     log_fldr=r'./', save_log_file=True,
                                     binary_path_fldr=r'./data/output/request/test_taz/',
                                     region_gdf=target_region_gdf, od_type='region_od')



åŸºäºè‡ªå®šä¹‰ODè¯·æ±‚è·¯å¾„ï¼Œè·å–è·¯ç½‘
````````````````````````````````````

ä½ å¯ä»¥é€šè¿‡è‡ªå·±çš„ç›¸å…³ç®—æ³•å»æ„é€ ODï¼Œç¡®ä¿ODè¡¨ç¬¦åˆ :doc:`æ•°æ®è¦æ±‚`ä¸­çš„å¸¦é€”å¾„ç‚¹çš„ODæ•°æ® è¦æ±‚ ï¼Œç„¶åå¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰ODå»è¯·æ±‚è·¯å¾„ã€æ„é€ è·¯ç½‘

ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

.. code-block:: python
    :linenos:

    if __name__ == '__main__':
        nv = ng.NetReverse(flag_name='test_diy_od', net_out_fldr=r'./data/output/reverse/test_diy_od/',
                           plain_crs='EPSG:32651', save_tpr_link=True, angle_threshold=20)
        nv.generate_net_from_request(binary_path_fldr=r'./data/output/request/test_diy_od/',
                                     key_list=['ä½ çš„Key'],
                                     od_file_path=r'./data/output/od/è‹å·å¸‚.csv', od_type='diy_od')

        # æˆ–è€…
        # diy_od_df = pd.read_csv(r'./data/output/od/è‹å·å¸‚.csv')
        # nv.generate_net_from_request(binary_path_fldr=r'./data/output/request/test_diy_od/',
        #                              key_list=['ä½ çš„Key'],
        #                              od_df=diy_od_df,
        #                              od_type='diy_od')


æœ¬ç®—æ³•åŒ…æä¾›äº†ä¸€ä¸ªä¾æ®GPSæ•°æ®æ¥ç”Ÿäº§è‡ªå®šä¹‰ODçš„æ¥å£ï¼Œå‚è§ :doc:`è½¨è¿¹å¤„ç†`ä¸­çš„ å¸¦é€”å¾„ç‚¹ODè®¡ç®—


è§£æè·¯å¾„æºæ–‡ä»¶, è·å–è·¯ç½‘
````````````````````````````````````

ä»¥ä¸Šä»‹ç»çš„nv.generate_net_from_requestå‡½æ•°æ˜¯ä¸€æ¬¡æ€§å°†è·¯å¾„è¯·æ±‚å’Œè·¯ç½‘é€†å‘åšå®Œï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥å°†å…¶æ‹†åˆ†ä¸ºä¸¤ä¸ªå•ç‹¬çš„æ­¥éª¤è¿›è¡Œï¼š

(1). nv.request_pathï¼šåªè¯·æ±‚è·¯å¾„å¹¶ä¸”ç¼“å­˜

(2). nv.generate_net_from_pickle: è§£ææœ¬åœ°çš„è·¯å¾„æºæ–‡ä»¶, è·å–è·¯ç½‘


å¦‚æœå·²ç»æœ‰äº†è¯·æ±‚å¥½çš„è·¯å¾„æºæ–‡ä»¶ï¼Œå¯ä»¥ç›´æ¥ä»è·¯å¾„æºæ–‡ä»¶ä¸­åˆ›å»ºè·¯ç½‘ï¼Œåªéœ€è¦æŒ‡å®šè·¯å¾„æºæ–‡ä»¶ç›®å½•å’Œè·¯å¾„æºæ–‡ä»¶åç§°åˆ—è¡¨

ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

.. code-block:: python
    :linenos:

    if __name__ == '__main__':
        nv = ng.NetReverse(flag_name='test_pickle', net_out_fldr=r'./data/output/reverse/test_pickle/',
                           plain_crs='EPSG:32650', save_tpr_link=True, angle_threshold=20)
        nv.generate_net_from_pickle(binary_path_fldr=r'./data/output/request/test_taz/',
                                    pickle_file_name_list=['14_test_taz_gd_path_1'])


åŸºäºå·²æœ‰è·¯ç½‘çº¿å±‚, ç”Ÿäº§ç‚¹å±‚
````````````````````````````````````

å¦‚æœä½ å·²ç»æœ‰äº†è·¯ç½‘çº¿å±‚(ä»osmæˆ–è€…å…¶ä»–ä»»ä½•é€”å¾„è·å–çš„)ï¼Œç¼ºå°‘æ‹“æ‰‘å…³è”å…³ç³»ä»¥åŠç‚¹å±‚ï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼æ„å»ºç‚¹å±‚ä»¥åŠæ·»åŠ ç‚¹å±‚ã€çº¿å±‚çš„å…³è”å…³ç³»

è¯¥æ¥å£ä¸ºNetReverseç±»çš„é™æ€æ–¹æ³•

ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

.. code-block:: python
    :linenos:

    if __name__ == '__main__':
        # å¯¹link.shpçš„è¦æ±‚: åªéœ€è¦æœ‰geometryå­—æ®µå³å¯, ä½†æ˜¯geometryå­—æ®µçš„å‡ ä½•å¯¹è±¡å¿…é¡»ä¸ºLineStringç±»å‹(ä¸å…è®¸Zåæ ‡)
        link_gdf = gpd.read_file(r'./data/output/create_node/link.shp')
        print(link_gdf)
        # update_link_field_listæ˜¯éœ€è¦æ›´æ–°çš„è·¯ç½‘åŸºæœ¬å±æ€§å­—æ®µï¼šlink_idï¼Œfrom_nodeï¼Œto_nodeï¼Œlengthï¼Œdir
        # ç¤ºä¾‹ä¸­ï¼šlink_gdfæœ¬èº«å·²æœ‰dirå­—æ®µï¼Œæ‰€ä»¥æ²¡æœ‰æŒ‡å®šæ›´æ–°dir
        new_link_gdf, new_node_gdf, node_group_status_gdf = ng.NetReverse.create_node_from_link(link_gdf=link_gdf, using_from_to=False,
                                                                                     update_link_field_list=['link_id',
                                                                                                             'from_node',
                                                                                                             'to_node',
                                                                                                             'length'],
                                                                                     plain_crs='EPSG:32651',
                                                                                     modify_minimum_buffer=0.7,
                                                                                     execute_modify=True,
                                                                                     ignore_merge_rule=True,
                                                                                     out_fldr=r'./data/output/create_node/')


å¯ç”¨å¤šæ ¸å¹¶è¡Œé€†å‘è·¯ç½‘
````````````````````````````````````

è‹¥éœ€è¦è·å–å¤§èŒƒå›´çš„è·¯ç½‘ï¼Œæˆ‘ä»¬æ¨èä½¿ç”¨å¤šæ ¸å¹¶è¡Œè¯·æ±‚ï¼Œå³åœ¨åˆå§‹åŒ–NetReverseç±»æ—¶ï¼ŒæŒ‡å®šmulti_core_reverse=Trueï¼Œreverse_core_num=x

ç¨‹åºä¼šè‡ªåŠ¨å°†è·¯ç½‘åˆ’åˆ†ä¸ºxä¸ªå­åŒºåŸŸï¼Œåœ¨æ¯ä¸ªå­åŒºåŸŸå†…è¿›è¡Œå¹¶è¡Œè®¡ç®—ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

.. code-block:: python
    :linenos:

    if __name__ == '__main__':
        # åˆå§‹åŒ–ng.NetReverseç±»æŒ‡å®šmulti_core_reverse=True, reverse_core_num=x
        nv = ng.NetReverse(flag_name='sh',
                           net_out_fldr=r'./data/output/shanghai/net/',
                           plain_crs='EPSG:32651', save_tpr_link=True, angle_threshold=30, multi_core_reverse=True,
                           reverse_core_num=2)

        # ç„¶åå¯ä»¥ä½¿ç”¨nv.generate_net_from_pickleæˆ–è€…nv.generate_net_from_requestæˆ–è€…nv.redivide_link_nodeè¿›è¡Œè·¯ç½‘ç”Ÿäº§æˆ–ä¼˜åŒ–


.. image:: _static/images/multi_region.png
    :align: center

-------------------------------------------------------

è®¡ç®—ç»“æŸåï¼Œåœ¨net_out_fldrä¸‹ä¼šç”Ÿæˆxä¸ªå­æ–‡ä»¶å¤¹ï¼Œåˆ†åˆ«å­˜æ”¾æœ€ç»ˆçš„å­åŒºåŸŸè·¯ç½‘ï¼Œå¦‚æœä½ æƒ³å°†è¿™äº›è·¯ç½‘è¿›è¡Œåˆå¹¶ï¼Œè¯·ä½¿ç”¨è·¯ç½‘åˆå¹¶æ¥å£


åˆå¹¶gotrackitæ ‡å‡†è·¯ç½‘
````````````````````````````````````

åˆå¹¶å¤šä¸ªåœ°åŒºçš„æ ‡å‡†è·¯ç½‘ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

.. code-block:: python
    :linenos:

    if __name__ == '__main__':
        fldr = r'F:\PyPrj\TrackIt\data\input\net\test\all_sichuan_path\net'
        net_list = []
        for i in range(0,6):
            net_list.append([gpd.read_file(os.path.join(fldr, f'region-{i}', 'FinalLink.shp')),
                             gpd.read_file(os.path.join(fldr, f'region-{i}', 'FinalNode.shp'))])

        l, n = ng.NetReverse.merge_net(net_list=net_list, conn_buffer=0.2,
                                       out_fldr=r'F:\PyPrj\TrackIt\data\input\net\test\all_sichuan_path\net\merge')


è§£æé«˜ç²¾åœ°å›¾
````````````````````````

ç»™å‡ºSUMOè·¯ç½‘(.net.xml)æ–‡ä»¶è·¯å¾„ï¼Œè¯¥æ¨¡å—å¯ä»¥å¸®åŠ©ä½ è§£æå‡ºç›¸åº”çš„è½¦é“çº§æ‹“æ‰‘éª¨æ¶ï¼Œå¦‚æœä½ æœ‰.odræˆ–è€….xodrç­‰é«˜ç²¾åœ°å›¾æ•°æ®ï¼Œå¯ä»¥å…ˆä½¿ç”¨sumoçš„ `netconvert <https://sumo.dlr.de/docs/netconvert.html>`_ è½¬åŒ–ä¸º.net.xmlåå†ä½¿ç”¨gotrackitè¿›è¡Œè§£æ

.. code-block:: python
    :linenos:

    from gotrackit.netxfer.SumoConvert import SumoConvert
    if __name__ == '__main__':
        sc = SumoConvert()
        lane_gdf, junction_gdf, lane_polygon_gdf, avg_edge_gdf, conn_gdf = sc.get_net_shp(net_path=r'./way.net.xml')

        # lane_gdf = lane_gdf.to_crs('EPSG:4326')
        # ......

.. note::
    è§£æå‡ºæ¥çš„GeoDataFrameï¼Œå…¶åæ ‡ç³»ä¸net.xmlä¿æŒä¸€è‡´ï¼Œä¸ä¸€å®šæ˜¯EPSG:4326ï¼Œéœ€è¦ä½¿ç”¨to_crsè¿›è¡Œè½¬æ¢


.. image:: _static/images/sumo_xfer.png
    :align: center

-------------------------------------------------------

è·¯ç½‘ä¼˜åŒ–
-------------------------


ä»¥ä¸‹ä¼˜åŒ–æ“ä½œä¸æ˜¯å¿…é¡»è¦åšçš„ï¼Œå¤§å®¶ä¾æ®è‡ªå·±çš„è·¯ç½‘æƒ…å†µé€‰æ‹©ä½¿ç”¨å³å¯

.. _æ¸…æ´—è·¯ç½‘çº¿å±‚æ•°æ®:

æ¸…æ´—è·¯ç½‘çº¿å±‚æ•°æ®
```````````````````````````


å¦‚æœä½ å·²ç»æœ‰äº†è·¯ç½‘çº¿å±‚æ•°æ®(ä»osmæˆ–è€…å…¶ä»–ä»»ä½•é€”å¾„è·å–çš„), ä½ å¯èƒ½æƒ³ä½¿ç”¨nv.create_node_from_linkå‡½æ•°æ¥ç”Ÿäº§ç‚¹å±‚ä»¥åŠç”Ÿäº§æ‹“æ‰‘å…³è”ä»¥å¾—åˆ°æ ‡å‡†çš„è·¯ç½‘æ•°æ®ï¼Œä½†æ˜¯nv.create_node_from_linkå¯èƒ½ä¼šæŠ¥é”™ï¼Œå› ä¸ºä½ çš„è·¯ç½‘çº¿å±‚æ•°æ®å¯èƒ½åŒ…å«äº†Multiç±»å‹æˆ–è€…æ˜¯å¸¦æœ‰zåæ ‡æˆ–è€…æ˜¯çº¿å¯¹è±¡ä¸­å«æœ‰å¤§é‡çš„é‡å ç‚¹ï¼Œä½ å¯ä»¥ä½¿ç”¨nvç±»çš„é™æ€æ–¹æ³•clean_link_geoæ¥æ¶ˆé™¤zåæ ‡ä»¥åŠmultiç±»å‹


ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

.. code-block:: python
    :linenos:

    if __name__ == '__main__':

        # è¯»å–æ•°æ®
        df = gpd.read_file(r'./data/output/request/0304/é“è·¯åŒçº¿20230131_84.shp')

        # å¤„ç†geometry
        # l_thresholdè¡¨ç¤ºå°†çº¿å‹ä¸­è·ç¦»å°äºl_thresholdç±³çš„æŠ˜ç‚¹è¿›è¡Œåˆå¹¶ï¼Œç®€åŒ–è·¯ç½‘ï¼ŒåŒæ—¶æ¶ˆé™¤é‡å æŠ˜ç‚¹
        # l_thresholdæ¨è 1m ~ 5mï¼Œè¿‡å¤§ä¼šå¯¼è‡´çº¿å‹ç»†èŠ‚å¤±çœŸ
        # plain_crsæ˜¯è¦ä½¿ç”¨çš„å¹³é¢æŠ•å½±åæ ‡ç³»
        link_gdf = ng.NetReverse.clean_link_geo(gdf=df, plain_crs='EPSG:32649', l_threshold=1.0)


ä¿®å¤è”é€šæ€§
`````````````````

å¦‚æœä½ å·²ç»æœ‰äº†è·¯ç½‘çº¿å±‚å’Œç‚¹å±‚(ä¸”å­—æ®µå’Œæ‹“æ‰‘å…³è”å…³ç³»æ»¡è¶³æœ¬ç®—æ³•åŒ…çš„è¦æ±‚)ï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼æ¥æ£€æŸ¥è·¯ç½‘çš„è”é€šæ€§

ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

.. code-block:: python
    :linenos:

    if __name__ == '__main__':
        link_gdf = gpd.read_file(r'./data/input/net/test/sz/FinalLink.shp')
        node_gdf = gpd.read_file(r'./data/input/net/test/sz/FinalNode.shp')

        # net_file_typeæŒ‡çš„æ˜¯è¾“å‡ºè·¯ç½‘æ–‡ä»¶çš„ç±»å‹
        nv = ng.NetReverse(net_file_type='shp', conn_buffer=0.8, net_out_fldr=r'./data/input/net/test/sz/')
        new_link_gdf, new_node_gdf = nv.modify_conn(link_gdf=link_gdf, node_gdf=node_gdf, book_mark_name='sz_conn_test', generate_mark=True)

        print(new_link_gdf)
        print(new_node_gdf)

åœ¨net_out_fldrä¸‹ä¼šç”Ÿæˆè”é€šæ€§ä¿®å¤å®Œæˆåçš„è·¯ç½‘æ–‡ä»¶ä»¥åŠxmlç©ºé—´ä¹¦ç­¾æ–‡ä»¶ï¼Œå°†xmlæ–‡ä»¶å¯¼å…¥åˆ°QGISå¯ä»¥æŸ¥çœ‹ä¿®å¤çš„ç‚¹ä½æƒ…å†µä»¥ä¾¿æ’æŸ¥æ˜¯å¦æ‰€æœ‰ä¿®å¤éƒ½æ˜¯åˆç†çš„


ä»€ä¹ˆæ˜¯è”é€šæ€§ä¿®å¤ï¼Ÿ

.. image:: _static/images/conn_1.png
    :align: center

--------------------------------------------------------------------------------

.. image:: _static/images/conn_2.png
    :align: center

--------------------------------------------------------------------------------


è·¯æ®µåˆ’åˆ†
`````````````````

ä½ å·²ç»æœ‰äº†ä¸€å¥—linkå’Œnodeæ–‡ä»¶, ä½ å¸Œæœ›å¯¹linkå±‚è¿›è¡Œè·¯æ®µé‡å¡‘ï¼Œå³å°†é•¿åº¦å¤§äºL(m)çš„è·¯æ®µéƒ½è¿›æ‰“æ–­ï¼ŒåŒæ—¶ç‚¹å±‚æ•°æ®ä¹Ÿä¼šéšä¹‹è‡ªåŠ¨å˜åŒ–

è¯¥æ¥å£ä¸ºNetReverseç±»çš„é™æ€æ–¹æ³•

åˆ’åˆ†å‰ï¼š

.. image:: _static/images/before_divide.png
    :align: center

--------------------------------------------------------------------------------

åˆ’åˆ†åï¼š

åˆ’åˆ†åï¼Œä¼šç”Ÿäº§ä¸€ä¸ªæ–°çš„å­—æ®µï¼š_parent_linkï¼Œç”¨äºè®°å½•æ­¤è·¯æ®µåœ¨åˆ’åˆ†å‰æ‰€å±çš„link_idï¼Œå¦‚æœä¸ºç©ºå€¼ï¼Œè¯´æ˜è¯¥è·¯æ®µæ²¡æœ‰å‘ç”Ÿåˆ’åˆ†

.. image:: _static/images/after_divide.png
    :align: center

--------------------------------------------------------------------------------

ä»gotrackitå¯¼å…¥ç›¸å…³æ¨¡å— ::

    import gotrackit.netreverse.NetGen as ng


.. code-block:: python
    :linenos:

    if __name__ == '__main__':
        link = gpd.read_file(r'./data/input/net/test/0317/link1.geojson')
        node = gpd.read_file(r'./data/input/net/test/0317/node1.geojson')

        nv = ng.NetReverse()
        # æ‰§è¡Œåˆ’åˆ†è·¯ç½‘
        # divide_l: æ‰€æœ‰é•¿åº¦å¤§äºdivide_lçš„è·¯æ®µéƒ½å°†æŒ‰ç…§divide_lè¿›è¡Œåˆ’åˆ†
        # min_l: åˆ’åˆ†åå¦‚æœå‰©ä¸‹çš„è·¯æ®µé•¿åº¦å°äºmin_l, é‚£ä¹ˆæ­¤æ¬¡åˆ’åˆ†å°†ä¸è¢«å…è®¸
        new_link, new_node = nv.divide_links(link_gdf=link, node_gdf=node, divide_l=50, min_l=5.0)

        new_link.to_file(r'./data/input/net/test/0317/divide_link.geojson', driver='GeoJSON', encoding='gbk')
        new_node.to_file(r'./data/input/net/test/0317/divide_node.geojson', driver='GeoJSON', encoding='gbk')


idé‡æ˜ å°„
`````````````````

ä»gotrackitå¯¼å…¥ç›¸å…³æ¨¡å— ::

    import gotrackit.netreverse.NetGen as ng

å¦‚æœä½ çš„linkè¡¨çš„link_idæˆ–è€…nodeè¡¨çš„node_idæ˜¯ä¸€ä¸ªéå¸¸å¤§çš„æ•´æ•°, ä½¿ç”¨è¿™æ ·çš„è·¯ç½‘å­˜åœ¨é£é™©ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‡½æ•°è¿›è¡ŒIDé‡æ˜ å°„

è¯¥æ¥å£ä¸ºNetReverseç±»çš„é™æ€æ–¹æ³•

.. code-block:: python
    :linenos:

    if __name__ == '__main__':
        l = gpd.read_file(r'./data/input/net/xian/modifiedConn_link.shp')
        n = gpd.read_file(r'./data/input/net/xian/modifiedConn_node.shp')
        print(l[['link_id', 'from_node', 'to_node']])
        print(n[['node_id']])
        nv = ng.NetReverse()
        nv.remapping_link_node_id(l, n)
        print(l[['link_id', 'from_node', 'to_node']])
        print(n[['node_id']])


è·¯ç½‘è·¯æ®µã€èŠ‚ç‚¹é‡å¡‘
`````````````````

ä½ å·²ç»æœ‰äº†ä¸€å¥—linkæ–‡ä»¶ï¼Œä½†æ˜¯å…¶å­˜åœ¨æŠ˜ç‚¹è”é€šæ€§é—®é¢˜ï¼Œå¦‚ä¸‹å›¾ï¼š

.. image:: _static/images/before_redivide.jpg
    :align: center

--------------------------------------------------------------------------------


å¯ä»¥ä½¿ç”¨è¯¥æ¥å£è¿›è¡Œè·¯æ®µå’ŒèŠ‚ç‚¹çš„é‡å¡‘ä»¥åŠè”é€šæ€§çš„ä¼˜åŒ–ï¼Œä½ åªéœ€è¦è¾“å…¥ä¸€ä¸ªçº¿å±‚ï¼Œè¯¥å‡½æ•°ä¼šå¸®ä½ é‡å¡‘èŠ‚ç‚¹åˆ’åˆ†ä»¥åŠè·¯æ®µåˆ’åˆ†ï¼Œå¹¶ä¸”ä¿®å¤è”é€šæ€§

.. code-block:: python
    :linenos:

    if __name__ == '__main__':
        # è¯»å–æ•°æ®
        origin_link = gpd.read_file(r'./data/input/net/test/0402BUG/load/test_link.geojson')
        print(origin_link)

        # ä¸ºé˜²æ­¢çº¿å±‚çº¿å‹æœ‰é‡å¤ç‚¹ï¼Œå…ˆåšæ¸…æ´—
        origin_link = ng.NetReverse.clean_link_geo(gdf=origin_link, l_threshold=1.0, plain_crs='EPSG:32650')

        # multi_core_merge=Trueè¡¨ç¤ºå¯ç”¨å¤šè¿›ç¨‹è¿›è¡Œæ‹“æ‰‘ä¼˜åŒ–
        # merge_core_numè¡¨ç¤ºå¯ç”¨ä¸¤ä¸ªæ ¸
        nv = ng.NetReverse(net_out_fldr=r'./data/input/net/test/0402BUG/redivide',
                           plain_crs='EPSG:32650', flag_name='new_divide', multi_core_merge=True,
                           merge_core_num=2)

        # è·¯æ®µã€èŠ‚ç‚¹é‡æ–°åˆ’åˆ†ã€è”é€šæ€§ä¿®å¤ï¼Œæ–°çš„ç½‘ç»œæ–‡ä»¶åœ¨net_out_fldrä¸‹ç”Ÿæˆ
        nv.redivide_link_node(link_gdf=origin_link)


é‡å¡‘ä¿®å¤åï¼š

.. image:: _static/images/after_redivide.jpg
    :align: center

--------------------------------------------------------------------------------


å¤„ç†ç¯è·¯å’Œç›¸åŒ(from_nodeï¼Œto_node)çš„è·¯æ®µ
```````````````````````````````````````````

gotrackitä¸å…è®¸è·¯ç½‘å‡ºç°ç¯è·¯ä»¥åŠ(from_nodeï¼Œto_node)ç›¸åŒçš„linkå­˜åœ¨(å¦‚ä¸‹å›¾), åœ¨æ„å»ºNetæ—¶ä¼šè‡ªåŠ¨è¯†åˆ«è¿™äº›linkå¹¶ä¸”è¿›è¡Œåˆ é™¤, å¦‚æœä½ æƒ³ä¿ç•™è¿™äº›linkè¯·ä½¿ç”¨circle_processè¿›è¡Œè·¯ç½‘å¤„ç†

è¯¥æ¥å£ä¸ºNetReverseç±»çš„é™æ€æ–¹æ³•

.. image:: _static/images/circle_before.jpg
    :align: center

--------------------------------------------------------------------------------

.. image:: _static/images/same_ft_before.jpg
    :align: center

--------------------------------------------------------------------------------


.. code-block:: python
    :linenos:

    import gotrackit.netreverse.NetGen as ng

    if __name__ == '__main__':
        l = gpd.read_file('./data/input/net/test/0506yg/link.shp')
        n = gpd.read_file('./data/input/net/test/0506yg/node.shp')

        # å¤„ç†ç¯è·¯å’Œç›¸åŒfrom_node - to_nodeçš„link
        new_link, new_node = ng.NetReverse.circle_process(link_gdf=l, node_gdf=n)

        # circle_processå¤„ç†åè¾“å‡ºçš„è·¯ç½‘æ˜¯å¹³é¢æŠ•å½±åæ ‡ç³», éœ€è¦è½¬åŒ–ä¸ºEPSG:4326
        new_link = new_link.to_crs('EPSG:4326')
        new_node = new_node.to_crs('EPSG:4326')

        new_link.to_file('./data/input/net/test/0506yg/new_link.shp')
        new_node.to_file('./data/input/net/test/0506yg/new_node.shp')



circle_processå¤„ç†åå¦‚å›¾

.. image:: _static/images/circle_after.jpg
    :align: center

--------------------------------------------------------------------------------

.. image:: _static/images/same_ft_after.jpg
    :align: center

--------------------------------------------------------------------------------


è·¯ç½‘æ¨¡å—å‡½æ•°æ–¹æ³•çš„ç›¸å…³å‚æ•°è§ :doc:`ç±»æ–¹æ³•æ±‡æ€»`


ğŸš— è½¨è¿¹å¤„ç†
===================================


è¡Œç¨‹åˆ‡åˆ†
-----------------------------

åŸå§‹çš„GPSæ•°æ®åŒ…å«äº†ä¸€è¾†è½¦çš„å¤šæ¬¡å‡ºè¡Œï¼Œæˆ‘ä»¬éœ€è¦å¯¹è½¦è¾†çš„å‡ºè¡Œè¿›è¡Œåˆ’åˆ†ã€‚é‚£ä¹ˆå¦‚ä½•ç†è§£ä¸»è¡Œç¨‹å’Œå­è¡Œç¨‹ï¼Ÿ


.. image:: _static/images/gps_process/è¡Œç¨‹åˆ‡åˆ†.png
    :align: center

* ä¸»è¡Œç¨‹ä¸¾ä¾‹
    ä¸€è¾†è½¦ä»å®¶å‡ºå‘åˆ°è¾¾å…¬å¸ï¼Œå°†è½¦è¾†åœåœ¨è½¦åº“ï¼Œç†„ç«åï¼Œè½¦è¾†ä¸å†äº§ç”ŸGPSæ•°æ®ï¼Œä¸‹ç­åå†æ¬¡å¯åŠ¨ï¼ŒGPSæ•°æ®é‡æ–°äº§ç”Ÿï¼Œæ—©ä¸Šåˆ°è¾¾å…¬å¸çš„æœ€åä¸€ä¸ªå®šä½ç‚¹å’Œä¸‹ç­åå¯åŠ¨è½¦è¾†çš„ç¬¬ä¸€ä¸ªå®šä½ç‚¹ï¼Œå…¶æ—¶é—´å·®è¶…è¿‡group_gap_thresholdï¼Œåˆ™åœ¨æ­¤å¤„åˆ‡åˆ†ä¸»è¡Œç¨‹

* å­è¡Œç¨‹ä¸¾ä¾‹
 ä¸€è¾†è½¦ä»å®¶å‡ºå‘åˆ°è¾¾å…¬å¸ï¼Œåœ¨åˆ°è¾¾å…¬å¸ä¹‹å‰ï¼Œåœ¨åŠ æ²¹ç«™åŠ æ²¹ï¼ŒGPSç‚¹æŒç»­äº§ç”Ÿï¼Œä½†æ˜¯å®šä½ç‚¹é›†ä¸­åœ¨åŠ æ²¹ç«™é™„è¿‘ï¼Œäº§ç”Ÿäº†åœç•™ï¼Œé‚£ä¹ˆä»å®¶-åŠ æ²¹ç«™å°±æ˜¯ä¸€æ®µå­è¡Œç¨‹


æ¯ä¸€ä¸ªæ®µä¸»è¡Œç¨‹ã€å­è¡Œç¨‹ï¼Œå‡æ‹¥æœ‰ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„agent_id


GpsPreProcessç±»åˆå§‹åŒ–
```````````````````````````````

GpsPreProcessæä¾›äº†è¡Œç¨‹åˆ‡åˆ†(trip_segmentations)ã€æŠ½å–å¸¦é€”å¾„ç‚¹ä¿¡æ¯çš„OD(sampling_waypoints_od)è¿™ä¸¤å¤§åŠŸèƒ½ï¼Œä½ åªéœ€è¦ä¼ å…¥GPSè¡¨æ•°æ®å³å¯ï¼Œç¡®ä¿GPSæ•°æ®æ»¡è¶³ :doc:`æ•°æ®è¦æ±‚` ä¸­çš„GPSæ•°æ®è¦æ±‚ã€‚

ç±»åˆå§‹åŒ–å‚æ•°ä¸ºï¼š

* gps_df
    gpsæ•°æ®è¡¨ï¼Œç±»å‹ï¼špd.DataFrameï¼Œå¿…é¡»æŒ‡å®š

* use_multi_core
    æ˜¯å¦å¯ç”¨å¤šæ ¸å¹¶è¡Œï¼Œé»˜è®¤Falseï¼Œæ•°æ®é‡è¾ƒå¤§æ—¶å¯ä»¥å¯ç”¨

* used_core_num
    å¯ç”¨çš„æ ¸æ•°ï¼Œé»˜è®¤2


è¡Œç¨‹åˆ‡åˆ†(trip_segmentations)
`````````````````````````````````````````````````````

trip_segmentationså‡½æ•°æä¾›äº†ä¸»è¡Œç¨‹å’Œå­è¡Œç¨‹çš„åˆ’åˆ†åŠŸèƒ½ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š


.. code-block:: python
    :linenos:

    import pandas as pd
    from gotrackit.gps.GpsTrip import GpsPreProcess

    if __name__ == '__main__':
        # è¯»å–GPSæ•°æ®
        gps_gdf = pd.read_csv(r'data/output/gps/example/origin_gps.cssv')

        # æ–°å»ºä¸€ä¸ªGpsPreProcessç¤ºä¾‹
        grp = GpsPreProcess(gps_df=gps_gdf, use_multi_core=False)

        # è°ƒç”¨trip_segmentationsæ–¹æ³•è¿›è¡Œè¡Œç¨‹åˆ‡åˆ†
        # åˆ‡åˆ†åçš„æ•°æ®ä¼šæ›´æ–°agent_idå­—æ®µç”¨ä»¥åŒºåˆ†ä¸åŒçš„å‡ºè¡Œæ—…ç¨‹ï¼ŒåŸGPSè¡¨çš„agent_idä¼šå­˜å‚¨åœ¨origin_agent_idå­—æ®µä¸­
        gps_trip = grp.trip_segmentations(group_gap_threshold=1800, plain_crs='EPSG:32650', min_distance_threshold=10.0)

        gps_trip.to_csv(r'./data/output/gps/example/gps_trip.csv', encoding='utf_8_sig', index=False)


trip_segmentationså‡½æ•°ç›¸å…³å‚æ•°å¦‚ä¸‹ï¼š

* time_format
    GPSæ•°æ®ä¸­æ—¶é—´åˆ—çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¨¡æ¿, é»˜è®¤"%Y-%m-%d %H:%M:%S"ï¼Œå¯ä»¥å‚ç…§pandasä¸­pd.to_datetime()å‡½æ•°çš„formatå‚æ•°

    å‚è€ƒï¼š`pd.to_datetimeè§£é‡Š <https://pandas.pydata.org/pandas-docs/version/0.20/generated/pandas.to_datetime.html#>`_ã€`ISO_8601 <https://en.wikipedia.org/wiki/ISO_8601>`_

* time_unit
    GPSæ•°æ®ä¸­æ—¶é—´åˆ—çš„å•ä½, å¦‚æœæ—¶é—´åˆ—æ˜¯æ•°å€¼(ç§’æˆ–è€…æ¯«ç§’,s æˆ–è€… ms), ç³»ç»Ÿä¼šè‡ªåŠ¨æŒ‰ç…§è¯¥å‚æ•°æ„å»ºæ—¶é—´åˆ—, é»˜è®¤'s'ã€‚Gotrackitä¼šå…ˆå°è¯•ä½¿ç”¨time_formatè¿›è¡Œæ—¶é—´åˆ—æ„å»ºï¼Œå¦‚æœå¤±è´¥ä¼šå†æ¬¡å°è¯•ä½¿ç”¨time_unitè¿›è¡Œæ—¶é—´åˆ—æ„å»º

* plain_crs
    ä¾æ®ç ”ç©¶èŒƒå›´ï¼Œé€‰æ‹©ä¸€ä¸ªåˆé€‚çš„å¹³é¢æŠ•å½±åæ ‡ç³»ï¼Œè¯¦æƒ…è§ :doc:`æ•°æ®è¦æ±‚` ä¸­çš„å¹³é¢æŠ•å½±åæ ‡ç³»è§£é‡Š

* group_gap_threshold
    æ—¶é—´é˜ˆå€¼ï¼Œä¸»è¡Œç¨‹åˆ’åˆ†å‚æ•°ï¼Œå•ä½ç§’ï¼Œå¦‚æœå‰åGPSç‚¹çš„å®šä½æ—¶é—´è¶…è¿‡è¯¥é˜ˆå€¼ï¼Œåˆ™åœ¨è¯¥ç‚¹åˆ‡åˆ†ä¸»è¡Œç¨‹ï¼Œé»˜è®¤1800s(30åˆ†é’Ÿ)

* min_distance_threshold
    å­è¡Œç¨‹åˆ‡åˆ†è·ç¦»é˜ˆå€¼ï¼Œå•ä½ç±³ï¼Œé»˜è®¤10.0mï¼Œå¦‚æœä½ åªæƒ³åˆ’åˆ†ä¸»è¡Œç¨‹ï¼Œåˆ™æŒ‡å®šmin_distance_thresholdä¸ºè´Ÿæ•°å³å¯

* dwell_accu_time
    å­è¡Œç¨‹åˆ‡åˆ†æ—¶é—´é˜ˆå€¼ï¼Œç§’ï¼Œé»˜è®¤60ç§’

* n
    å­è¡Œç¨‹åˆ‡åˆ†å‚æ•°ï¼Œæ•´æ•°ï¼Œå¦‚æœè¶…è¿‡è¿ç»­nä¸ªgpsç‚¹çš„è·ç¦»å°äºmin_distance_threshold ä¸” æŒç»­æ—¶é—´è¶…è¿‡dwell_accu_timeï¼Œé‚£ä¹ˆè¯¥å¤„è¢«è¯†åˆ«ä¸ºåœç•™ç‚¹ï¼Œä»è¯¥å¤„åˆ‡åˆ†å­è¡Œç¨‹ï¼Œé»˜è®¤5



.. _é€”å¾„ç‚¹ODè®¡ç®—:

ä»GPSæ•°æ®è®¡ç®—é€”å¾„ç‚¹OD
`````````````````````````````````````````````````````

å¦‚æœä½ çš„GPSæ•°æ®å·²ç»å®Œæˆäº†è¡Œç¨‹åˆ‡åˆ†ï¼Œä¸”å·²ç»æŒ‰ç…§agent_idã€timeä¸¤ä¸ªå­—æ®µå‡åºæ’åˆ—ï¼Œé‚£ä¹ˆä½ å¯ä»¥ç›´æ¥ä½¿ç”¨è¯¥æ¥å£è¿›è¡Œé€”å¾„ç‚¹çš„æŠ½æ ·ï¼Œå¾—åˆ°å¸¦é€”å¾„ç‚¹çš„ODæ•°æ®è¡¨

ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

.. code-block:: python
    :linenos:

    import pandas as pd
    from gotrackit.gps.GpsTrip import GpsPreProcess

    if __name__ == '__main__':
        # è¯»å–GPSæ•°æ®
        gps_gdf = pd.read_csv(r'data/output/gps/example/gps_trip.cssv')

        # æ–°å»ºä¸€ä¸ªGpsPreProcessç¤ºä¾‹
        grp = GpsPreProcess(gps_df=gps_gdf, use_multi_core=False)

        # è¿”å›çš„ç¬¬ä¸€ä¸ªæ•°æ®æ˜¯ODè¡¨(pd.DataFrame)ï¼Œç¬¬äºŒä¸ªæ•°æ®æ˜¯ODçº¿(gpd.GeoDataFrame)
        gps_od, od_line = grp.sampling_waypoints_od(way_points_num=2)
        gps_od.to_csv(r'./data/output/gps_od.csv', encoding='utf_8_sig', index=False)
        od_line.to_file(r'./data/output/gps_od.shp')


sampling_waypoints_odç›¸å…³å‚æ•°å¦‚ä¸‹ï¼š

* way_points_num
    æ•´æ•°ï¼ŒODçš„é€”å¾„ç‚¹æ•°ç›®ï¼Œå¿…é¡»â‰¤10ï¼Œé»˜è®¤5ä¸ªé€”å¾„ç‚¹





è½¨è¿¹æ•°æ®æ¸…æ´—
-----------------------------

è¦ä½¿ç”¨gotrackitçš„è½¨è¿¹æ•°æ®æ¸…æ´—æ¨¡å—ï¼Œç¡®ä¿è¾“å…¥çš„GPSæ•°æ®æ»¡è¶³ :doc:`æ•°æ®è¦æ±‚` ä¸­çš„GPSæ•°æ®è¦æ±‚ã€‚

åˆ©ç”¨gotrackitæä¾›çš„TrajectoryPointsç±»å¯ä»¥å¯¹è½¨è¿¹æ•°æ®è¿›è¡Œå„ç§é¢„å¤„ç†ï¼šé—´éš”é‡‡æ ·ã€åœç•™ç‚¹è¯†åˆ«ã€æ»‘åŠ¨çª—å£å¹³å‡ã€è½¨è¿¹ç‚¹ç®€åŒ–ã€å¡å°”æ›¼æ»¤æ³¢å¹³æ»‘ï¼Œè¿™äº›æ–¹æ³•éƒ½å°è£…åœ¨äº†TrajectoryPointsç±»ä¸­

TrajectoryPointsåˆå§‹åŒ–çš„ç›¸å…³å‚æ•°æœ‰ï¼š

* gps_points_df
    gpsæ•°æ®

.. _æ—¶é—´åˆ—æ„å»ºå‚æ•°:

* time_format
    GPSæ•°æ®ä¸­æ—¶é—´åˆ—çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¨¡æ¿, é»˜è®¤"%Y-%m-%d %H:%M:%S"ï¼Œå¯ä»¥å‚ç…§pandasä¸­pd.to_datetime()å‡½æ•°çš„formatå‚æ•°

    å‚è€ƒï¼š`pd.to_datetimeè§£é‡Š <https://pandas.pydata.org/pandas-docs/version/0.20/generated/pandas.to_datetime.html#>`_ã€`ISO_8601 <https://en.wikipedia.org/wiki/ISO_8601>`_

* time_unit
    GPSæ•°æ®ä¸­æ—¶é—´åˆ—çš„å•ä½, å¦‚æœæ—¶é—´åˆ—æ˜¯æ•°å€¼(ç§’æˆ–è€…æ¯«ç§’,s æˆ–è€… ms), ç³»ç»Ÿä¼šè‡ªåŠ¨æŒ‰ç…§è¯¥å‚æ•°æ„å»ºæ—¶é—´åˆ—, é»˜è®¤'s'ã€‚Gotrackitä¼šå…ˆå°è¯•ä½¿ç”¨time_formatè¿›è¡Œæ—¶é—´åˆ—æ„å»ºï¼Œå¦‚æœå¤±è´¥ä¼šå†æ¬¡å°è¯•ä½¿ç”¨time_unitè¿›è¡Œæ—¶é—´åˆ—æ„å»º


* plain_crs:
    è¦ä½¿ç”¨çš„å¹³é¢æŠ•å½±åæ ‡ç³»ï¼Œé»˜è®¤Noneï¼Œç”¨æˆ·è‹¥ä¸æŒ‡å®šï¼Œç¨‹åºä¼šä¾æ®è·¯ç½‘çš„ç»çº¬åº¦èŒƒå›´è‡ªåŠ¨è¿›è¡Œ6åº¦æŠ•å½±å¸¦çš„é€‰æ‹©, æ¨èä½¿ç”¨ç¨‹åºè‡ªåŠ¨

    è‹¥è¦æ‰‹åŠ¨æŒ‡å®šï¼šå‚è§: è¯¦æƒ…è§ :doc:`æ•°æ®è¦æ±‚` ä¸­çš„å¹³é¢æŠ•å½±åæ ‡ç³»è§£é‡Š

TrajectoryPointsæä¾›äº†ä»¥ä¸‹è½¨è¿¹ç‚¹æ¸…æ´—æ–¹æ³•ï¼š


åœç•™ç‚¹åˆ é™¤
````````````````````````

.. image:: _static/images/gps_process/åˆ é™¤åœç•™ç‚¹.png
    :align: center

--------------------------------------------------------------------------------

* del_dwell_points():

    dwell_l_length: åœç•™ç‚¹è¯†åˆ«è·ç¦»é˜ˆå€¼, é»˜è®¤å€¼5.0m

    dwell_n: è¶…è¿‡è¿ç»­dwell_nä¸ªç›¸é‚»GPSç‚¹çš„è·ç¦»å°äºdwell_l_lengthï¼Œé‚£ä¹ˆè¿™ä¸€ç»„ç‚¹å°±ä¼šè¢«è¯†åˆ«ä¸ºåœç•™ç‚¹ï¼Œé»˜è®¤2


è½¨è¿¹ç‚¹å¢å¯†
````````````````````````

.. image:: _static/images/gps_process/è½¨è¿¹å¢å¯†.png
    :align: center

--------------------------------------------------------------------------------

* dense():
    dense_interval: å½“ç›¸é‚»GPSç‚¹çš„çƒé¢è·ç¦»Lè¶…è¿‡dense_intervalå³è¿›è¡Œå¢å¯†, è¿›è¡Œ int(L / dense_interval) + 1 ç­‰åˆ†åŠ å¯†, é»˜è®¤100.0


è½¨è¿¹ç‚¹é™é¢‘
``````````````````````````

.. image:: _static/images/gps_process/é—´éš”é‡‡æ ·.png
    :align: center

--------------------------------------------------------------------------------

* lower_frequency():
    lower_n: é™é¢‘å€ç‡, é»˜è®¤2


æ»‘åŠ¨çª—å£å¹³æ»‘
``````````````````````````


.. image:: _static/images/gps_process/æ»‘åŠ¨çª—å£å¹³å‡.png
    :align: center

--------------------------------------------------------------------------------

* rolling_average():
    rolling_window: æ»‘åŠ¨çª—å£å¤§å°, é»˜è®¤2


ç¦»çº¿å¡å°”æ›¼æ»¤æ³¢å¹³æ»‘
``````````````````````````

.. image:: _static/images/gps_process/ç¦»çº¿å¡å°”æ›¼.png
    :align: center

--------------------------------------------------------------------------------

* kf_smooth():

    p_deviation:  è½¬ç§»è¿‡ç¨‹çš„å™ªå£°æ ‡å‡†å·®ï¼Œé»˜è®¤0.01

    o_deviation:  è§‚æµ‹è¿‡ç¨‹çš„å™ªå£°æ ‡å‡†å·®ï¼Œé»˜è®¤0.1ï¼Œo_deviationè¶Šå°ï¼Œ æ»¤æ³¢å¹³æ»‘åçš„ç»“æœè¶Šæ¥è¿‘è§‚æµ‹è½¨è¿¹(å³æºè½¨è¿¹)

.. note::
    å®šä½æ•°æ®çš„timeåˆ—å¯¹å¹³æ»‘çš„æ•ˆæœæœ‰å½±å“ï¼Œå¦‚ä½¿ç”¨æ»¤æ³¢å¹³æ»‘ï¼Œè¯·ç¡®ä¿ä½ çš„å®šä½æ•°æ®æ—¶é—´åˆ—çš„åˆç†æ€§



è½¨è¿¹ç®€åŒ–
``````````````````````````


.. image:: _static/images/gps_process/è½¨è¿¹ç®€åŒ–.png
    :align: center

--------------------------------------------------------------------------------

* simplify_trajectory():

    l_threshold: ç®€åŒ–é˜ˆå€¼ï¼Œé»˜è®¤5.0m


è½¨è¿¹æ¸…æ´—å’Œå¯è§†åŒ–
``````````````````````````

.. image:: _static/images/gps_process/é“¾å¼æ“ä½œ.png
    :align: center

--------------------------------------------------------------------------------


ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

.. code-block:: python
    :linenos:

    import pandas as pd
    from gotrackit.gps.Trajectory import TrajectoryPoints

    if __name__ == '__main__':
        gps_df = pd.read_csv(r'gps.csv')

        # å»é™¤åŒä¸€å‡ºè¡Œä¸­çš„ç›¸åŒå®šä½æ—¶é—´ç‚¹æ•°æ®
        gps_df.drop_duplicates(subset=['agent_id', 'time'], keep='first', inplace=True)
        gps_df.reset_index(inplace=True, drop=True)

        # æ„å»ºTrajectoryPointsç±», å¹¶ä¸”æŒ‡å®šä¸€ä¸ªplain_crs
        tp = TrajectoryPoints(gps_points_df=gps_df, time_unit='ms', plain_crs='EPSG:32649')

        # é—´éš”3ä¸ªç‚¹é‡‡æ ·ä¸€ä¸ªç‚¹
        # tp.lower_frequency(lower_n=3)


        # å¡å°”æ›¼æ»¤æ³¢å¹³æ»‘
        tp.kf_smooth()

        # ä½¿ç”¨é“¾å¼æ“ä½œè‡ªå®šä¹‰é¢„å¤„ç†çš„å…ˆåé¡ºåº, åªè¦ä¿è¯kf_smooth()æ“ä½œåæ²¡æœ‰æ‰§è¡Œ - æ»‘åŠ¨çª—å£å¹³æ»‘ã€å¢å¯†ï¼Œå¤„ç†åçš„è½¨è¿¹æ•°æ®å³å¯å¾—åˆ°åˆ†é¡¹é€Ÿåº¦æ•°æ®
        # tp.simplify_trajectory().del_dwell_points()
        # tp.dense().kf_smooth()
        # tp.lower_frequency().dense().kf_smooth()


        # è·å–æ¸…æ´—åçš„ç»“æœ
        # _typeå‚æ•°å¯ä»¥å–å€¼ä¸º df æˆ–è€… gdf
        process_df = tp.trajectory_data(_type='df')

        out_fldr = r'./data/output/'

        # å­˜å‚¨ç»“æœ
        process_df.to_csv(os.path.join(out_fldr, r'after_reprocess_gps.csv'), encoding='utf_8_sig', index=False)

        # è¾“å‡ºä¸ºhtmlè¿›è¡ŒåŠ¨æ€å¯è§†åŒ–
        tp.export_html(out_fldr=out_fldr, file_name='sample')


.. note::
    ä½¿ç”¨é“¾å¼æ“ä½œè‡ªå®šä¹‰é¢„å¤„ç†çš„å…ˆåé¡ºåº, åªè¦ä¿è¯kf_smooth()æ“ä½œåæ²¡æœ‰æ‰§è¡Œ: æ»‘åŠ¨çª—å£å¹³æ»‘ï¼Œå¤„ç†åçš„è½¨è¿¹æ•°æ®å³å¯å¾—åˆ°åˆ†é¡¹é€Ÿåº¦æ•°æ®



è¾“å‡ºçš„htmlæ–‡ä»¶å¯ä»¥åŠ¨æ€å¯è§†åŒ–æ¸…æ´—å‰åçš„è½¨è¿¹ç‚¹å¯¹æ¯”


.. image:: _static/images/gps_process/visualization.png
    :align: center

--------------------------------------------------------------------------------

